<!-- hr_app/templates/hr/training_management.html -->{% extends 'base.html' %}{% block title %}Training Management{% endblock %}{% block content %}<h4>Training Management</h4><div class="mb-5">    <a href="{% url 'staff_dashboard' %}" class="btn btn-info py-2 d-block d-md-inline-block mx-1 mb-2 mb-md-0">Back to Dashboard</a>        <a href="{% url 'manage_crews' %}" class="btn btn-info py-2 d-block d-md-inline-block mx-1 mb-2 mb-md-0">Manage Crews</a>    <a href="{% url 'timeclock_report' %}" class="btn btn-info py-2 d-block d-md-inline-block mx-1 mb-2 mb-md-0">Timeclock Report</a>    <a href="{% url 'bulk_renew_training' %}" class="btn btn-info py-2 d-block d-md-inline-block mx-1 mb-2 mb-md-0">Bulk Renew Training</a>    <a href="{% url 'staff_message' %}" class="btn btn-info py-2 d-block d-md-inline-block mx-1 mb-2 mb-md-0">Post Message</a>    <form method="post" action="{% url 'logout' %}" style="display: inline;">        {% csrf_token %}        <button type="submit" class="btn btn-danger py-2 d-block d-md-inline-block mx-1 mb-2 mb-md-0">Logout</button>    </form></div><!-- Certification Alerts --><div class="mb-3">    <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#certAlerts" aria-expanded="false" aria-controls="certAlerts">        Certification Alerts ({{ expiring_certs.count|add:expired_certs.count }})    </button>    <div class="collapse" id="certAlerts">        <div class="mt-2">            <h4>Expiring Soon (Within 30 Days)</h4>            <table class="table table-bordered">                <thead>                    <tr>                        <th>Employee</th>                        <th>Certification</th>                        <th>Expires</th>                        <th>Dismiss</th>                    </tr>                </thead>                <tbody>                {% for cert in expiring_certs %}                    <tr>                        <td>{{ cert.employee.last_name }}, {{ cert.employee.first_name }}</td>                        <td>{{ cert.certification.name }}</td>                        <td>{{ cert.expiration_date }}</td>                        <td>                            <form method="post" style="display: inline;">                                {% csrf_token %}                                <input type="hidden" name="cert_id" value="{{ cert.id }}">                                <input type="checkbox" name="dismiss" onchange="this.form.submit()" class="form-check-input">                                <input type="hidden" name="dismiss_cert" value="1">                            </form>                        </td>                    </tr>                {% empty %}                    <tr><td colspan="4">No certifications expiring soon.</td></tr>                {% endfor %}                </tbody>            </table>            <h4 style="color: red;">Expired Certifications</h4>            <table class="table table-bordered">                <thead>                    <tr>                        <th>Employee</th>                        <th>Certification</th>                        <th>Expired On</th>                        <th>Dismiss</th>                    </tr>                </thead>                <tbody>                {% for cert in expired_certs %}                    <tr>                        <td>{{ cert.employee.last_name }}, {{ cert.employee.first_name }}</td>                        <td>{{ cert.certification.name }}</td>                        <td>{{ cert.expiration_date }}</td>                        <td>                            <form method="post" style="display: inline;">                                {% csrf_token %}                                <input type="hidden" name="cert_id" value="{{ cert.id }}">                                <input type="checkbox" name="dismiss" onchange="this.form.submit()" class="form-check-input">                                <input type="hidden" name="dismiss_cert" value="1">                            </form>                        </td>                    </tr>                {% empty %}                    <tr><td colspan="4">No expired certifications.</td></tr>                {% endfor %}                </tbody>            </table>        </div>    </div></div><!-- Manage Certifications --><div class="mb-3">    <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#manageCertifications" aria-expanded="false" aria-controls="manageCertifications">        Manage Certifications ({{ cert_formset.forms|length }})    </button>    <div class="collapse" id="manageCertifications">        <form method="post" class="mt-2">            {% csrf_token %}            {{ cert_formset.management_form }}            <table class="table table-bordered">                <thead>                    <tr>                        <th>Name</th>                        <th>Description</th>                        <th>Duration (Months)</th>                        <th>Delete</th>                    </tr>                </thead>                <tbody>                {% for form in cert_formset %}                    <tr>                        <td>{{ form.id }}{{ form.name }}</td>                        <td>{{ form.description }}</td>                        <td>{{ form.duration_months }}</td>                        <td>{{ form.DELETE }}</td>                    </tr>                {% endfor %}                </tbody>            </table>            <button type="submit" name="save_certifications" class="btn btn-primary">Save Certifications</button>        </form>    </div></div><!-- Manage Employee Certifications --><div class="mb-3">    <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#manageEmployeeCerts" aria-expanded="false" aria-controls="manageEmployeeCerts">        Manage Employee Certifications ({{ emp_cert_formset.forms|length }})    </button>    <div class="collapse {% if request.GET.filter_employee_certs %}show{% endif %}" id="manageEmployeeCerts">        <form method="get" class="mt-2 mb-3">            <input type="hidden" name="filter_employee_certs" value="1">            <div class="row">                <div class="col-md-3">                    {{ filter_form.state.label_tag }} {{ filter_form.state }}                </div>                <div class="col-md-3">                    {{ filter_form.crew.label_tag }} {{ filter_form.crew }}                </div>                <div class="col-md-3">                    {{ filter_form.employee_search.label_tag }} {{ filter_form.employee_search }}                </div>                <div class="col-md-3">                    {{ filter_form.site.label_tag }} {{ filter_form.site }}                </div>            </div>            <div class="mt-2">                <button type="submit" class="btn btn-primary">Filter</button>                <a href="{% url 'training_management' %}" class="btn btn-secondary">Reset</a>            </div>        </form>        <form method="post" class="mt-2" id="empCertForm">            {% csrf_token %}            {{ emp_cert_formset.management_form }}            {% if emp_cert_formset.errors or emp_cert_formset.non_form_errors %}                <div class="alert alert-danger">                    <strong>Form Errors:</strong>                    <ul>                        {% for form in emp_cert_formset %}                            {% for field in form %}                                {% for error in field.errors %}                                    <li>{{ form.instance.id|default:'New' }} - {{ field.label }}: {{ error }}</li>                                {% endfor %}                            {% endfor %}                            {% for error in form.non_field_errors %}                                <li>{{ form.instance.id|default:'New' }}: {{ error }}</li>                            {% endfor %}                        {% endfor %}                        {% for error in emp_cert_formset.non_form_errors %}                            <li>{{ error }}</li>                        {% endfor %}                    </ul>                </div>            {% endif %}            <table class="table table-bordered">                <thead>                    <tr>                        <th>Employee</th>                        <th>Certification</th>                        <th>Completed</th>                        <th>Expires</th>                        <th>Renew</th>                        <th>Delete</th>                    </tr>                </thead>                <tbody>                {% for form in emp_cert_formset %}                    <tr {% if form.instance.expiration_date and form.instance.expiration_date < today %}class="table-danger"{% endif %}>                        <td>{{ form.id }}{{ form.employee }}</td>                        <td>{{ form.certification }}</td>                        <td>                            {% if form.instance.id %}                                {{ form.instance.completion_date|date:"Y-m-d" }}                            {% else %}                                {{ form.completion_date }}                                {% if form.completion_date.errors %}                                    <span class="text-danger">{{ form.completion_date.errors.0 }}</span>                                {% endif %}                            {% endif %}                        </td>                        <td>                            {% if form.instance.id %}                                <span class="expiration-date" data-cert-id="{{ form.instance.id }}">{{ form.instance.expiration_date|date:"Y-m-d"|default_if_none:'N/A' }}</span>                            {% else %}                                {{ form.expiration_date }}                                {% if form.expiration_date.errors %}                                    <span class="text-danger">{{ form.expiration_date.errors.0 }}</span>                                {% endif %}                            {% endif %}                        </td>                        <td>                            {% if form.instance.id %}                                <form method="post" class="d-inline renewal-form" data-cert-id="{{ form.instance.id }}">                                    {% csrf_token %}                                    <input type="hidden" name="renew_certification" value="1">                                    <input type="hidden" name="certification_id" value="{{ form.instance.id }}">                                    <input type="date" name="new_expiration_date" class="form-control d-inline-block w-auto">                                    <button type="submit" class="btn btn-sm btn-success">Renew</button>                                </form>                            {% endif %}                        </td>                        <td>{{ form.DELETE }}</td>                    </tr>                {% endfor %}                </tbody>            </table>            <button type="submit" name="save_employee_certs" class="btn btn-primary">Save Employee Certifications</button>        </form>    </div></div><!-- Manage Jobsites --><div class="mb-3">    <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#manageJobsites" aria-expanded="false" aria-controls="manageJobsites">        Manage Jobsites ({{ jobsite_formset.forms|length }})    </button>    <div class="collapse" id="manageJobsites">        <form method="post" class="mt-2">            {% csrf_token %}            {{ jobsite_formset.management_form }}            <table class="table table-bordered">                <thead>                    <tr>                        <th>Name</th>                        <th>Location</th>                        <th style="min-width: 400px;">Required Certifications</th>                        <th>Site-Specific Training</th>                        <th>Delete</th>                    </tr>                </thead>                <tbody>                {% for form in jobsite_formset %}                    <tr>                        <td>{{ form.id }}{{ form.name }}</td>                        <td>{{ form.location }}</td>                        <td style="position: relative;">                            <button type="button" class="btn btn-sm btn-link" data-bs-toggle="collapse" data-bs-target="#certCollapse{{ forloop.counter }}" aria-expanded="false" aria-controls="certCollapse{{ forloop.counter }}">                                Show/Hide Certifications                            </button>                            <div class="collapse" id="certCollapse{{ forloop.counter }}">                                <div style="min-width: 350px; max-height: 200px; overflow-y: auto; padding: 15px; background-color: #fff; border: 1px solid #ddd;">                                    <ul style="list-style: none; padding-left: 0; margin: 0;">                                        {% for checkbox in form.required_certifications %}                                            <li class="form-check">                                                {{ checkbox.tag }}                                                <label class="form-check-label" for="{{ checkbox.id_for_label }}" style="margin-left: 5px;">{{ checkbox.choice_label }}</label>                                            </li>                                        {% endfor %}                                    </ul>                                </div>                            </div>                        </td>                        <td>{{ form.site_specific_training }}</td>                        <td>{{ form.DELETE }}</td>                    </tr>                {% endfor %}                </tbody>            </table>            <button type="submit" name="save_jobsites" class="btn btn-primary">Save Jobsites</button>        </form>    </div></div><!-- Search Qualified Employees (Always Visible) --><h3>Search Qualified Employees</h3><form method="get" class="mb-3">    <div class="row">        <div class="col-md-6">            <select name="jobsite" class="form-control">                <option value="">Select a Jobsite</option>                {% for jobsite in jobsites %}                    <option value="{{ jobsite.name }}" {% if jobsite.name == search_jobsite %}selected{% endif %}>{{ jobsite.name }}</option>                {% endfor %}            </select>        </div>        <div class="col-md-6">            <button type="submit" class="btn btn-primary">Search</button>        </div>    </div></form>{% if search_jobsite %}    <h4>Fully Qualified Employees for {{ search_jobsite }}</h4>    <ul>    {% for emp in qualified_employees %}        <li>{{ emp.last_name }}, {{ emp.first_name }}</li>    {% empty %}        <li>No fully qualified employees found.</li>    {% endfor %}    </ul>    <h4>Partially Qualified Employees for {{ search_jobsite }} (Top 5 Closest Matches)</h4>    <table class="table table-bordered">        <thead>            <tr>                <th>Employee</th>                <th>Missing Certifications</th>                <th>Expired Certifications</th>                <th>Needs Site-Specific Training</th>            </tr>        </thead>        <tbody>        {% for emp, missing_certs, expired_certs, has_site_specific in partial_qualified %}            <tr>                <td>{{ emp.last_name }}, {{ emp.first_name }}</td>                <td>                    {% if missing_certs %}                        <ul>                        {% for cert in missing_certs %}                            <li>{{ cert.name }}</li>                        {% endfor %}                        </ul>                    {% else %}                        None                    {% endif %}                </td>                <td>                    {% if expired_certs %}                        <ul>                        {% for cert in expired_certs %}                            <li>{{ cert.certification.name }} (Expired: {{ cert.expiration_date }})</li>                        {% endfor %}                        </ul>                    {% else %}                        None                    {% endif %}                </td>                <td>{% if not has_site_specific %}Yes{% else %}No{% endif %}</td>            </tr>        {% empty %}            <tr><td colspan="4">No partially qualified employees found.</td></tr>        {% endfor %}        </tbody>    </table>{% endif %}<script>document.addEventListener('DOMContentLoaded', function() {    const renewalForms = document.querySelectorAll('.renewal-form');    renewalForms.forEach(form => {        form.addEventListener('submit', function(e) {            e.preventDefault();            const formData = new FormData(this);            const certId = this.getAttribute('data-cert-id');            fetch(window.location.href, {                method: 'POST',                body: formData,                headers: {                    'X-Requested-With': 'XMLHttpRequest' // Indicate AJAX request                }            })            .then(response => response.json())            .then(data => {                if (data.success) {                    // Update the expiration date in the table without reloading                    const expirationCell = document.querySelector(`.expiration-date[data-cert-id="${certId}"]`);                    if (expirationCell) {                        expirationCell.textContent = data.new_expiration_date;                    }                    // Clear the input field                    this.querySelector('input[name="new_expiration_date"]').value = '';                } else {                    alert(data.error || 'An error occurred while renewing the certification.');                }            })            .catch(error => {                console.error('Error:', error);                alert('An error occurred while processing the request.');            });        });    });});</script><a href="{% url 'staff_dashboard' %}" class="btn btn-info py-2 d-block d-md-inline-block mx-1 mb-2 mb-md-0">Back to Dashboard</a>    {% endblock %}