{% extends "base.html" %}{% block title %}Timeclock Report{% endblock %}{% block content %}<h4>Timeclock Report</h4><div class="mb-5">    <a href="{% url 'staff_dashboard' %}" class="btn btn-info py-2 d-block d-md-inline-block mx-1 mb-2 mb-md-0">Back to Dashboard</a>        <a href="{% url 'manage_crews' %}" class="btn btn-info py-2 d-block d-md-inline-block mx-1 mb-2 mb-md-0">Manage Crews</a>    <a href="{% url 'training_management' %}" class="btn btn-info py-2 d-block d-md-inline-block mx-1 mb-2 mb-md-0">Training Management</a>    <a href="{% url 'bulk_renew_training' %}" class="btn btn-info py-2 d-block d-md-inline-block mx-1 mb-2 mb-md-0">Bulk Renew Training</a>    <a href="{% url 'staff_message' %}" class="btn btn-info py-2 d-block d-md-inline-block mx-1 mb-2 mb-md-0">Post Message</a>    <form method="post" action="{% url 'logout' %}" style="display: inline;">        {% csrf_token %}        <button type="submit" class="btn btn-danger py-2 d-block d-md-inline-block mx-1 mb-2 mb-md-0">Logout</button>    </form></div><!-- Manual Entry Form -->{% if request.user.is_staff %}<div class="mb-4">    <h3>Add Manual Timeclock Entry</h3>    <form method="post" class="mb-3">        {% csrf_token %}        <div class="row">            <div class="col-md-2">                <label for="{{ manual_form.user.id_for_label }}">Employee:</label>                {{ manual_form.user }}            </div>            <div class="col-md-2">                <label for="{{ manual_form.site.id_for_label }}">Site:</label>                {{ manual_form.site }}            </div>            <div class="col-md-2">                <label for="{{ manual_form.crew.id_for_label }}">Crew:</label>                {{ manual_form.crew }}            </div>            <div class="col-md-3">                <label for="{{ manual_form.clock_in.id_for_label }}">Clock In:</label>                {{ manual_form.clock_in }}            </div>            <div class="col-md-3">                <label for="{{ manual_form.clock_out.id_for_label }}">Clock Out:</label>                {{ manual_form.clock_out }}            </div>        </div>        <button type="submit" name="add_manual_entry" class="btn btn-success mt-2">Add Entry</button>    </form>    {% if manual_form.errors %}        <div class="alert alert-danger">            <ul>                {% for field in manual_form %}                    {% for error in field.errors %}                        <li>{{ field.label }}: {{ error }}</li>                    {% endfor %}                {% endfor %}                {% for error in manual_form.non_field_errors %}                    <li>{{ error }}</li>                {% endfor %}            </ul>        </div>    {% endif %}</div>{% endif %}<!-- Existing Filter and Report Form --><form method="post" class="mb-3">    {% csrf_token %}    <div class="row">        <div class="col-md-3">            <label for="{{ filter_form.state.id_for_label }}">State:</label>            {{ filter_form.state }}        </div>        <div class="col-md-3">            <label for="{{ filter_form.crew.id_for_label }}">Crew:</label>            {{ filter_form.crew }}        </div>        <div class="col-md-3">            <label for="{{ filter_form.employee_search.id_for_label }}">Employee Search:</label>            {{ filter_form.employee_search }}        </div>        <div class="col-md-3">            <label for="{{ filter_form.site.id_for_label }}">Site:</label>            {{ filter_form.site }}        </div>    </div>    <div class="row mt-2">        <div class="col-md-3">            <label for="id_start_date">Start Date:</label>            <input type="date" name="start_date" id="id_start_date" value="{{ start_date|default:'' }}" class="form-control">        </div>        <div class="col-md-3">            <label for="id_end_date">End Date:</label>            <input type="date" name="end_date" id="id_end_date" value="{{ end_date|default:'' }}" class="form-control">        </div>    </div>    <div class="mt-2">        <button type="submit" class="btn btn-primary">Search</button>        <a href="{% url 'timeclock_report' %}" class="btn btn-primary">Reset</a>        <label for="csv_filename" class="ms-2">CSV Filename:</label>        <input type="text" name="csv_filename" id="csv_filename" value="timeclock_report" class="form-control d-inline-block w-auto">        <button type="submit" name="export_csv" class="btn btn-primary">Export CSV</button>    </div></form>{% if is_filtered %}    {% if timeclock_entries %}        <button class="btn btn-primary mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#timeclockEntries" aria-expanded="false" aria-controls="timeclockEntries">            Show Timeclock Entries ({{ timeclock_entries.count }})        </button>        <div class="collapse" id="timeclockEntries">            {% if request.user.is_staff %}            <form method="post">                {% csrf_token %}                <table class="table table-striped">                    <thead>                        <tr>                            <th>Employee</th>                            <th>Clock In</th>                            <th>Clock Out</th>                            <th>Hours Worked</th>                            <th>Crew</th>                            <th>Site</th>                            <th>Hours Type</th>                            <th>Shift</th>                            <th>WC Code</th>                            <th>Task Code</th>                            <th>Job ID</th>                            <th>Phase</th>                            <th>Project No</th>                            <th>Ticket No</th>                            <th>Per Diem</th>                            <th>Location</th>                            <th>Supervisor</th>                            <th>Non-Billable</th>                            <th>Invoice No</th>                            <th>Dept</th>                            <th>Notes</th>                            <th>Delete</th>                        </tr>                    </thead>                    <tbody>                    {% for entry in timeclock_entries %}                        <tr>                            <td>{{ entry.user.last_name }}, {{ entry.user.first_name }}</td>                            <td><input type="datetime-local" name="clock_in[{{ entry.id }}]" value="{{ entry.clock_in|date:'Y-m-d\TH:i' }}"></td>                            <td><input type="datetime-local" name="clock_out[{{ entry.id }}]" value="{% if entry.clock_out %}{{ entry.clock_out|date:'Y-m-d\TH:i' }}{% endif %}"></td>                            <td>{{ entry.hours_worked|default:'' }}</td>                            <td>                                <select name="crew[{{ entry.id }}]">                                    <option value="">None</option>                                    {% for crew in crews %}                                        <option value="{{ crew.id }}" {% if entry.crew == crew %}selected{% endif %}>{{ crew.name }}</option>                                    {% endfor %}                                </select>                            </td>                            <td>                                <select name="site[{{ entry.id }}]">                                    <option value="">None</option>                                    {% for site in sites %}                                        <option value="{{ site.id }}" {% if entry.site == site %}selected{% endif %}>{{ site.name }}</option>                                    {% endfor %}                                </select>                            </td>                            <td><input type="text" name="hours_type[{{ entry.id }}]" value="{{ entry.hours_type }}"></td>                            <td><input type="text" name="shift[{{ entry.id }}]" value="{{ entry.shift }}"></td>                            <td><input type="text" name="wc_code[{{ entry.id }}]" value="{{ entry.wc_code }}"></td>                            <td><input type="text" name="task_code[{{ entry.id }}]" value="{{ entry.task_code }}"></td>                            <td><input type="text" name="job_id[{{ entry.id }}]" value="{{ entry.job_id }}"></td>                            <td><input type="text" name="phase[{{ entry.id }}]" value="{{ entry.phase }}"></td>                            <td><input type="text" name="project_no[{{ entry.id }}]" value="{{ entry.project_no }}"></td>                            <td><input type="text" name="tkt_no[{{ entry.id }}]" value="{{ entry.tkt_no }}"></td>                            <td><input type="text" name="perdiem[{{ entry.id }}]" value="{{ entry.perdiem|default:'' }}"></td>                            <td><input type="text" name="location[{{ entry.id }}]" value="{{ entry.location }}"></td>                            <td>                                <select name="supervisor[{{ entry.id }}]">                                    <option value="">None</option>                                    {% for user in users %}                                        <option value="{{ user.id }}" {% if entry.supervisor == user %}selected{% endif %}>{{ user.last_name }}, {{ user.first_name }}</option>                                    {% endfor %}                                </select>                            </td>                            <td><input type="text" name="non_bill[{{ entry.id }}]" value="{{ entry.non_bill }}"></td>                            <td><input type="text" name="invoice_no[{{ entry.id }}]" value="{{ entry.invoice_no }}"></td>                            <td><input type="text" name="dept[{{ entry.id }}]" value="{{ entry.dept }}"></td>                            <td><input type="text" name="notes[{{ entry.id }}]" value="{{ entry.notes }}"></td>                            <td><input type="checkbox" name="delete[{{ entry.id }}]"></td>                        </tr>                    {% endfor %}                    </tbody>                </table>                <button type="submit" name="save_all" class="btn btn-primary">Save All</button>            </form>            {% else %}            <table class="table table-striped">                <thead>                    <tr>                        <th>Employee</th>                        <th>Clock In</th>                        <th>Clock Out</th>                        <th>Hours Worked</th>                        <th>Crew</th>                        <th>Site</th>                    </tr>                </thead>                <tbody>                {% for entry in timeclock_entries %}                    <tr>                        <td>{{ entry.user.last_name }}, {{ entry.user.first_name }}</td>                        <td>{{ entry.clock_in }}</td>                        <td>{{ entry.clock_out|default:'' }}</td>                        <td>{{ entry.hours_worked|default:'' }}</td>                        <td>{{ entry.crew.name|default:'' }}</td>                        <td>{{ entry.site.name|default:'' }}</td>                    </tr>                {% endfor %}                </tbody>            </table>            {% endif %}        </div>        <h3>Total Hours</h3>        <button class="btn btn-primary mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#totalHours" aria-expanded="false" aria-controls="totalHours">            Show Total Hours ({{ total_hours_list|length }})        </button>        <div class="collapse" id="totalHours">            <table class="table">                <thead>                    <tr>                        <th>Employee</th>                        <th>Total Hours</th>                    </tr>                </thead>                <tbody>                {% for user, hours in total_hours_list %}                    <tr>                        <td>{{ user.last_name }}, {{ user.first_name }}</td>                        <td>{{ hours }}</td>                    </tr>                {% endfor %}                </tbody>            </table>        </div>    {% else %}        <p>No timeclock entries found for the selected criteria.</p>    {% endif %}{% else %}    <p>Please apply a filter to view timeclock entries.</p>{% endif %}<div class="mt-3">    <a href="{% url 'staff_dashboard' %}" class="btn btn-info">Back to Dashboard</a></div>{% endblock %}